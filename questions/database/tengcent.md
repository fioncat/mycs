# 腾讯数据库面试题整理

**MySQL 为什么使用 B+ 树来作索引，对比 B 树它的优点和缺点是什么？**

B+树本身是一颗多叉树，只有叶子节点储存数据，而所有叶子节点会形成一个双向链表。MySQL使用B+树可以快速实现对某个key或某个范围key的查找，并且因为叶子节点组成了链表，在查找时一般不会涉及到回溯过程，而B树可以将数据储存在所有节点上面，所在在查找时可能会涉及到回溯导致大量的磁盘随机IO。

B+树缺点是必须走到叶子节点才能找到数据，因此在数据量较少时性能比B树要差。

**数据库的事务隔离级别有哪些？各有哪些优缺点？**

有4种隔离级别：

1. 未提交读

不加任何锁，但是可能会产生脏读。即使事务还没有提交，它的修改就会暴露给其他事务。这是最弱的隔离级别，但是性能是最高的。

2. 提交读

这个级别下，一个事务只能读到其他事物提交以后的数据，解决了脏读的问题。但是可能会产生不可重复读的问题，即在同一个事物之内，某个数据在读取第一次之后，被另外一个事务修改了，这时候再读取第二次，值会发生改变。

3. 可重复读

解决了上面可重复读的问题，在同一个事务中，同一个数据不会受到其他事物提交而产生影响。

这解决了数据更新的问题，但是没有解决数据插入的问题，假如某个事务需要对A=1的数据进行更新，更新之后再把A=1的数据查出来。在更新和查数据之间，另一个事务插入了一个A=1的数据，那么第一个事务更新之后查询会发现多出来了一个数据，这就产生了幻读。

4. 串行化

最严格的隔离级别，事务串行运行，但是效率最差。

MySQL实现事务隔离：

使用MVVC实现，一行记录在数据库中可能存在多个版本，版本表示产生这行数据的事务ID。可重复读在进行的时候会创建当前版本的一个全局快照，后面将会一直使用这个数据。而提交读在每次读都会创建一个临时快照。

事务在写的时候，如果写操作能够通过索引找到行，那么会对对应的行加行锁。如果没有索引，会锁住所有行，并在全标扫描时，将不需要更新的行的行锁给释放掉。

MySQL使用间隙锁解决了幻读问题，在对某个数据进行写操作时，会将该行以及它左右间隙（范围）的数据也加锁直到事务完成。这样其它事务就无法影响这些数据了。

**什么是数据库事务，MySQL 为什么会使用 InnoDB 作为默认选项**

事物就是一连串保证了ACID特性的数据库操作。

- A：原子性，所有操作要么一起完成，要么一起失败，没有中间状态。
- C：一致性，事务完成前后，数据都是可用的。这是事务的目标，例如转账操作前后两个账户的和必须相等。
- I：持久性，事务对数据的操作必须是持久化储存的。依靠数据看持久化来实现。
- D：隔离性，讨论了事务之间的隔离程度，有4个隔离级别。

InnoDB实现了ACID事务。所以是默认的。

**简述乐观锁以及悲观锁的区别以及使用场景**

- 悲观锁：每次在获取数据的时候都会加锁。
- 乐观锁：实际上是无锁的，利用CAS原子操作或版本号在更新数据时检查数据是否被他人更新。

乐观锁适用于写较少，读很多的场景。悲观锁适用于写很多的高竞争场景。

**产生死锁的必要条件有哪些？如何解决死锁？**

死锁要产生必须有循环依赖，即某个事务持有A锁，等待B锁；另一个事务持有B锁，等待A锁，它们之间形成了循环依赖，也就产生了死锁。

要解决，可以给所有锁加一个TTL，当时间过了锁还没有释放，进行事务的回滚并自动释放这个锁。或是开启死锁检测，当发生死锁，直接释放事务。

**聚簇索引和非聚簇索引有什么区别？**

聚簇索引将行的所有字段数据放在叶子节点上面，一般聚簇索引都是主键索引。非聚簇索引在叶子节点不存放字段数据，存放主键ID。因此在查询非聚簇索引的数据时可能需要回表到聚簇索引来获取数据的所有字段。